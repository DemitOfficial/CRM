/**
 * @fileoverview added by tsickle
 * Generated from: messaging.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __awaiter } from "tslib";
import { Inject, Injectable, InjectionToken, NgZone, Optional, PLATFORM_ID } from '@angular/core';
import firebase from 'firebase/app';
import { concat, EMPTY, Observable, of, throwError } from 'rxjs';
import { catchError, defaultIfEmpty, map, mergeMap, observeOn, switchMap, switchMapTo, shareReplay, subscribeOn } from 'rxjs/operators';
import { FIREBASE_APP_NAME, FIREBASE_OPTIONS, ɵAngularFireSchedulers, ɵfirebaseAppFactory, ɵlazySDKProxy, ɵapplyMixins } from '@angular/fire';
import { isPlatformServer } from '@angular/common';
import { proxyPolyfillCompat } from './base';
import { ɵfetchInstance } from '@angular/fire';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire";
/** @type {?} */
import * as ɵngcc0 from '@angular/core';
export const VAPID_KEY = new InjectionToken('angularfire2.messaging.vapid-key');
/** @type {?} */
export const SERVICE_WORKER = new InjectionToken('angularfire2.messaging.service-worker-registeration');
// SEMVER(7): drop
/** @type {?} */
const firebaseLTv8 = parseInt(firebase.SDK_VERSION, 10) < 8;
// WARNING: interface has both a type and a value, skipping emit
export class AngularFireMessaging {
    /**
     * @param {?} options
     * @param {?} nameOrConfig
     * @param {?} platformId
     * @param {?} zone
     * @param {?} vapidKey
     * @param {?} _serviceWorker
     */
    constructor(options, nameOrConfig, 
    // tslint:disable-next-line:ban-types
    platformId, zone, vapidKey, _serviceWorker) {
        /** @type {?} */
        const schedulers = new ɵAngularFireSchedulers(zone);
        /** @type {?} */
        const serviceWorker = _serviceWorker;
        /** @type {?} */
        const messaging = of(undefined).pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @return {?}
         */
        () => isPlatformServer(platformId) ? EMPTY : import('firebase/messaging'))), map((/**
         * @return {?}
         */
        () => ɵfirebaseAppFactory(options, zone, nameOrConfig))), switchMap((/**
         * @param {?} app
         * @return {?}
         */
        app => ɵfetchInstance(`${app.name}.messaging`, 'AngularFireMessaging', app, (/**
         * @return {?}
         */
        () => __awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const messaging = app.messaging();
            if (firebaseLTv8) {
                if (vapidKey) {
                    messaging.usePublicVapidKey(vapidKey);
                }
                if (serviceWorker) {
                    messaging.useServiceWorker(yield serviceWorker);
                }
            }
            return messaging;
        })), [vapidKey, serviceWorker]))), shareReplay({ bufferSize: 1, refCount: false }));
        this.requestPermission = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), 
        // tslint:disable-next-line
        switchMap((/**
         * @param {?} messaging
         * @return {?}
         */
        messaging => firebase.messaging.isSupported() ? messaging.requestPermission() : throwError('Not supported.'))));
        this.getToken = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @param {?} messaging
         * @return {?}
         */
        (messaging) => __awaiter(this, void 0, void 0, function* () {
            if (firebase.messaging.isSupported() && Notification.permission === 'granted') {
                if (firebaseLTv8) {
                    return yield messaging.getToken();
                }
                else {
                    /** @type {?} */
                    const serviceWorkerRegistration = serviceWorker ? yield serviceWorker : null;
                    return yield messaging.getToken({ vapidKey, serviceWorkerRegistration });
                }
            }
            else {
                return null;
            }
        }))));
        /** @type {?} */
        const notificationPermission$ = new Observable((/**
         * @param {?} emitter
         * @return {?}
         */
        emitter => {
            navigator.permissions.query({ name: 'notifications' }).then((/**
             * @param {?} notificationPerm
             * @return {?}
             */
            notificationPerm => {
                notificationPerm.onchange = (/**
                 * @return {?}
                 */
                () => emitter.next());
            }));
        }));
        /** @type {?} */
        const tokenChange$ = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMapTo(notificationPermission$), switchMapTo(this.getToken));
        this.tokenChanges = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @return {?}
         */
        () => firebase.messaging.isSupported() ? concat(this.getToken, tokenChange$) : EMPTY)));
        this.messages = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @param {?} messaging
         * @return {?}
         */
        messaging => firebase.messaging.isSupported() ? new Observable((/**
         * @param {?} emitter
         * @return {?}
         */
        emitter => messaging.onMessage((/**
         * @param {?} next
         * @return {?}
         */
        next => emitter.next(next)), (/**
         * @param {?} err
         * @return {?}
         */
        err => emitter.error(err)), (/**
         * @return {?}
         */
        () => emitter.complete())))) : EMPTY)));
        this.requestToken = of(undefined).pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @return {?}
         */
        () => this.requestPermission)), catchError((/**
         * @return {?}
         */
        () => of(null))), mergeMap((/**
         * @return {?}
         */
        () => this.tokenChanges)));
        // SEMVER(7): drop token
        this.deleteToken = (/**
         * @param {?=} token
         * @return {?}
         */
        (token) => messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @param {?} messaging
         * @return {?}
         */
        messaging => messaging.deleteToken(token || undefined))), defaultIfEmpty(false)));
        return ɵlazySDKProxy(this, messaging, zone);
    }
}
AngularFireMessaging.ɵfac = function AngularFireMessaging_Factory(t) { return new (t || AngularFireMessaging)(ɵngcc0.ɵɵinject(FIREBASE_OPTIONS), ɵngcc0.ɵɵinject(FIREBASE_APP_NAME, 8), ɵngcc0.ɵɵinject(PLATFORM_ID), ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(VAPID_KEY, 8), ɵngcc0.ɵɵinject(SERVICE_WORKER, 8)); };
/** @nocollapse */
AngularFireMessaging.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [FIREBASE_OPTIONS,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [FIREBASE_APP_NAME,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: NgZone },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [VAPID_KEY,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [SERVICE_WORKER,] }] }
];
/** @nocollapse */ AngularFireMessaging.ɵprov = i0.ɵɵdefineInjectable({ factory: function AngularFireMessaging_Factory() { return new AngularFireMessaging(i0.ɵɵinject(i1.FIREBASE_OPTIONS), i0.ɵɵinject(i1.FIREBASE_APP_NAME, 8), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(VAPID_KEY, 8), i0.ɵɵinject(SERVICE_WORKER, 8)); }, token: AngularFireMessaging, providedIn: "any" });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFireMessaging, [{
        type: Injectable,
        args: [{
                providedIn: 'any'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [FIREBASE_OPTIONS]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [FIREBASE_APP_NAME]
            }] }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }, { type: ɵngcc0.NgZone }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [VAPID_KEY]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [SERVICE_WORKER]
            }] }]; }, null); })();
if (false) {
    /** @type {?} */
    AngularFireMessaging.prototype.requestPermission;
    /** @type {?} */
    AngularFireMessaging.prototype.getToken;
    /** @type {?} */
    AngularFireMessaging.prototype.tokenChanges;
    /** @type {?} */
    AngularFireMessaging.prototype.messages;
    /** @type {?} */
    AngularFireMessaging.prototype.requestToken;
    /** @type {?} */
    AngularFireMessaging.prototype.deleteToken;
}
ɵapplyMixins(AngularFireMessaging, [proxyPolyfillCompat]);

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnaW5nLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi93b3Jrc3BhY2Uvc3JjL21lc3NhZ2luZy9tZXNzYWdpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2xHLE9BQU8sUUFBUSxNQUFNLGNBQWMsQ0FBQztBQUNwQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBYSxNQUFNLE1BQU0sQ0FBQztBQUM1RSxPQUFPLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBVSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoSixPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLGdCQUFnQixFQUdoQixzQkFBc0IsRUFDdEIsbUJBQW1CLEVBQ25CLGFBQWEsRUFFYixZQUFZLEVBQ2IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0M7QUFDb0M7QUFBcUM7O0FBQXpFLE1BQU0sT0FBTyxTQUFTLEdBQUcsSUFBSSxjQUFjLENBQVMsa0NBQWtDLENBQUM7QUFDdkY7QUFBQSxNQUFNLE9BQU8sY0FBYyxHQUFHLElBQUksY0FBYyxDQUFxQyxxREFBcUQsQ0FBQztBQUMzSTtBQUNrQjtBQUNGLE1BQVYsWUFBWSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENB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USxZQUFJLE1BQU0sU0FBQyxjQUFjO0FBQVE7QUFBRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2tDQVN4QztBQUFDO0FBQWE7QUFBcUIsSUF2QjFDLGlEQUFvRDtBQUN0RDtBQUFxQixJQUFuQix3Q0FBb0Q7QUFDdEQ7QUFBcUIsSUFBbkIsNENBQXdEO0FBQzFEO0FBQXFCLElBQW5CLHdDQUF5QztBQUMzQztBQUFxQixJQUFuQiw0Q0FBd0Q7QUFDMUQ7QUFBcUIsSUFBbkIsMkNBQW9FO0FBQ3RFO0FBMEdBLFlBQVksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztBQUMxRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE5nWm9uZSwgT3B0aW9uYWwsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgZmlyZWJhc2UgZnJvbSAnZmlyZWJhc2UvYXBwJztcbmltcG9ydCB7IGNvbmNhdCwgRU1QVFksIE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yLCBmcm9tRXZlbnQgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGRlZmF1bHRJZkVtcHR5LCBtYXAsIG1lcmdlTWFwLCBvYnNlcnZlT24sIHN3aXRjaE1hcCwgc3dpdGNoTWFwVG8sIHNoYXJlUmVwbGF5LCBmaWx0ZXIsIHN1YnNjcmliZU9uIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgRklSRUJBU0VfQVBQX05BTUUsXG4gIEZJUkVCQVNFX09QVElPTlMsXG4gIEZpcmViYXNlQXBwQ29uZmlnLFxuICBGaXJlYmFzZU9wdGlvbnMsXG4gIMm1QW5ndWxhckZpcmVTY2hlZHVsZXJzLFxuICDJtWZpcmViYXNlQXBwRmFjdG9yeSxcbiAgybVsYXp5U0RLUHJveHksXG4gIMm1UHJvbWlzZVByb3h5LFxuICDJtWFwcGx5TWl4aW5zXG59IGZyb20gJ0Bhbmd1bGFyL2ZpcmUnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybVNlcnZlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBwcm94eVBvbHlmaWxsQ29tcGF0IH0gZnJvbSAnLi9iYXNlJztcbmltcG9ydCB7IMm1ZmV0Y2hJbnN0YW5jZSB9IGZyb20gJ0Bhbmd1bGFyL2ZpcmUnO1xuXG5leHBvcnQgY29uc3QgVkFQSURfS0VZID0gbmV3IEluamVjdGlvblRva2VuPHN0cmluZz4oJ2FuZ3VsYXJmaXJlMi5tZXNzYWdpbmcudmFwaWQta2V5Jyk7XG5leHBvcnQgY29uc3QgU0VSVklDRV9XT1JLRVIgPSBuZXcgSW5qZWN0aW9uVG9rZW48UHJvbWlzZTxTZXJ2aWNlV29ya2VyUmVnaXN0cmF0aW9uPj4oJ2FuZ3VsYXJmaXJlMi5tZXNzYWdpbmcuc2VydmljZS13b3JrZXItcmVnaXN0ZXJhdGlvbicpO1xuXG4vLyBTRU1WRVIoNyk6IGRyb3BcbmNvbnN0IGZpcmViYXNlTFR2OCA9IHBhcnNlSW50KGZpcmViYXNlLlNES19WRVJTSU9OLCAxMCkgPCA4O1xuXG5leHBvcnQgaW50ZXJmYWNlIEFuZ3VsYXJGaXJlTWVzc2FnaW5nIGV4dGVuZHMgT21pdDzJtVByb21pc2VQcm94eTxmaXJlYmFzZS5tZXNzYWdpbmcuTWVzc2FnaW5nPiwgJ2RlbGV0ZVRva2VuJyB8ICdnZXRUb2tlbicgfCAncmVxdWVzdFBlcm1pc3Npb24nPiB7XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ2FueSdcbn0pXG5leHBvcnQgY2xhc3MgQW5ndWxhckZpcmVNZXNzYWdpbmcge1xuXG4gIHB1YmxpYyByZWFkb25seSByZXF1ZXN0UGVybWlzc2lvbjogT2JzZXJ2YWJsZTx2b2lkPjtcbiAgcHVibGljIHJlYWRvbmx5IGdldFRva2VuOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+O1xuICBwdWJsaWMgcmVhZG9ubHkgdG9rZW5DaGFuZ2VzOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+O1xuICBwdWJsaWMgcmVhZG9ubHkgbWVzc2FnZXM6IE9ic2VydmFibGU8e30+O1xuICBwdWJsaWMgcmVhZG9ubHkgcmVxdWVzdFRva2VuOiBPYnNlcnZhYmxlPHN0cmluZyB8IG51bGw+O1xuICBwdWJsaWMgcmVhZG9ubHkgZGVsZXRlVG9rZW46ICh0b2tlbjogc3RyaW5nKSA9PiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoRklSRUJBU0VfT1BUSU9OUykgb3B0aW9uczogRmlyZWJhc2VPcHRpb25zLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoRklSRUJBU0VfQVBQX05BTUUpIG5hbWVPckNvbmZpZzogc3RyaW5nIHwgRmlyZWJhc2VBcHBDb25maWcgfCBudWxsIHwgdW5kZWZpbmVkLFxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpiYW4tdHlwZXNcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwbGF0Zm9ybUlkOiBPYmplY3QsXG4gICAgem9uZTogTmdab25lLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoVkFQSURfS0VZKSB2YXBpZEtleTogc3RyaW5nfG51bGwsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChTRVJWSUNFX1dPUktFUikgX3NlcnZpY2VXb3JrZXI6IGFueSxcbiAgKSB7XG4gICAgY29uc3Qgc2NoZWR1bGVycyA9IG5ldyDJtUFuZ3VsYXJGaXJlU2NoZWR1bGVycyh6b25lKTtcbiAgICBjb25zdCBzZXJ2aWNlV29ya2VyOiBQcm9taXNlPFNlcnZpY2VXb3JrZXJSZWdpc3RyYXRpb24+IHwgbnVsbCA9IF9zZXJ2aWNlV29ya2VyO1xuXG4gICAgY29uc3QgbWVzc2FnaW5nID0gb2YodW5kZWZpbmVkKS5waXBlKFxuICAgICAgc3Vic2NyaWJlT24oc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhciksXG4gICAgICBvYnNlcnZlT24oc2NoZWR1bGVycy5pbnNpZGVBbmd1bGFyKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiBpc1BsYXRmb3JtU2VydmVyKHBsYXRmb3JtSWQpID8gRU1QVFkgOiBpbXBvcnQoJ2ZpcmViYXNlL21lc3NhZ2luZycpKSxcbiAgICAgIG1hcCgoKSA9PiDJtWZpcmViYXNlQXBwRmFjdG9yeShvcHRpb25zLCB6b25lLCBuYW1lT3JDb25maWcpKSxcbiAgICAgIHN3aXRjaE1hcChhcHAgPT4gybVmZXRjaEluc3RhbmNlKGAke2FwcC5uYW1lfS5tZXNzYWdpbmdgLCAnQW5ndWxhckZpcmVNZXNzYWdpbmcnLCBhcHAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgbWVzc2FnaW5nID0gYXBwLm1lc3NhZ2luZygpO1xuICAgICAgICBpZiAoZmlyZWJhc2VMVHY4KSB7XG4gICAgICAgICAgaWYgKHZhcGlkS2V5KSB7XG4gICAgICAgICAgICBtZXNzYWdpbmcudXNlUHVibGljVmFwaWRLZXkodmFwaWRLZXkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoc2VydmljZVdvcmtlcikge1xuICAgICAgICAgICAgbWVzc2FnaW5nLnVzZVNlcnZpY2VXb3JrZXIoYXdhaXQgc2VydmljZVdvcmtlcik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtZXNzYWdpbmc7XG4gICAgICB9LCBbdmFwaWRLZXksIHNlcnZpY2VXb3JrZXJdKSksXG4gICAgICBzaGFyZVJlcGxheSh7IGJ1ZmZlclNpemU6IDEsIHJlZkNvdW50OiBmYWxzZSB9KVxuICAgICk7XG5cbiAgICB0aGlzLnJlcXVlc3RQZXJtaXNzaW9uID0gbWVzc2FnaW5nLnBpcGUoXG4gICAgICBzdWJzY3JpYmVPbihzY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKSxcbiAgICAgIG9ic2VydmVPbihzY2hlZHVsZXJzLmluc2lkZUFuZ3VsYXIpLFxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgICBzd2l0Y2hNYXAobWVzc2FnaW5nID0+IGZpcmViYXNlLm1lc3NhZ2luZy5pc1N1cHBvcnRlZCgpID8gbWVzc2FnaW5nLnJlcXVlc3RQZXJtaXNzaW9uKCkgOiB0aHJvd0Vycm9yKCdOb3Qgc3VwcG9ydGVkLicpKVxuICAgICk7XG5cbiAgICB0aGlzLmdldFRva2VuID0gbWVzc2FnaW5nLnBpcGUoXG4gICAgICBzdWJzY3JpYmVPbihzY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKSxcbiAgICAgIG9ic2VydmVPbihzY2hlZHVsZXJzLmluc2lkZUFuZ3VsYXIpLFxuICAgICAgc3dpdGNoTWFwKGFzeW5jIG1lc3NhZ2luZyA9PiB7XG4gICAgICAgIGlmIChmaXJlYmFzZS5tZXNzYWdpbmcuaXNTdXBwb3J0ZWQoKSAmJiBOb3RpZmljYXRpb24ucGVybWlzc2lvbiA9PT0gJ2dyYW50ZWQnKSB7XG4gICAgICAgICAgaWYgKGZpcmViYXNlTFR2OCkge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG1lc3NhZ2luZy5nZXRUb2tlbigpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBzZXJ2aWNlV29ya2VyUmVnaXN0cmF0aW9uID0gc2VydmljZVdvcmtlciA/IGF3YWl0IHNlcnZpY2VXb3JrZXIgOiBudWxsO1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG1lc3NhZ2luZy5nZXRUb2tlbih7IHZhcGlkS2V5LCBzZXJ2aWNlV29ya2VyUmVnaXN0cmF0aW9uIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3Qgbm90aWZpY2F0aW9uUGVybWlzc2lvbiQgPSBuZXcgT2JzZXJ2YWJsZTxzdHJpbmc+KGVtaXR0ZXIgPT4ge1xuICAgICAgbmF2aWdhdG9yLnBlcm1pc3Npb25zLnF1ZXJ5KHsgbmFtZTogJ25vdGlmaWNhdGlvbnMnIH0pLnRoZW4obm90aWZpY2F0aW9uUGVybSA9PiB7XG4gICAgICAgIG5vdGlmaWNhdGlvblBlcm0ub25jaGFuZ2UgPSAoKSA9PiBlbWl0dGVyLm5leHQoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgdG9rZW5DaGFuZ2UkID0gbWVzc2FnaW5nLnBpcGUoXG4gICAgICBzdWJzY3JpYmVPbihzY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKSxcbiAgICAgIG9ic2VydmVPbihzY2hlZHVsZXJzLmluc2lkZUFuZ3VsYXIpLFxuICAgICAgc3dpdGNoTWFwVG8obm90aWZpY2F0aW9uUGVybWlzc2lvbiQpLFxuICAgICAgc3dpdGNoTWFwVG8odGhpcy5nZXRUb2tlbilcbiAgICApO1xuXG4gICAgdGhpcy50b2tlbkNoYW5nZXMgPSBtZXNzYWdpbmcucGlwZShcbiAgICAgIHN1YnNjcmliZU9uKHNjaGVkdWxlcnMub3V0c2lkZUFuZ3VsYXIpLFxuICAgICAgb2JzZXJ2ZU9uKHNjaGVkdWxlcnMuaW5zaWRlQW5ndWxhciksXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gZmlyZWJhc2UubWVzc2FnaW5nLmlzU3VwcG9ydGVkKCkgPyBjb25jYXQodGhpcy5nZXRUb2tlbiwgdG9rZW5DaGFuZ2UkKSA6IEVNUFRZKVxuICAgICk7XG5cblxuICAgIHRoaXMubWVzc2FnZXMgPSBtZXNzYWdpbmcucGlwZShcbiAgICAgIHN1YnNjcmliZU9uKHNjaGVkdWxlcnMub3V0c2lkZUFuZ3VsYXIpLFxuICAgICAgb2JzZXJ2ZU9uKHNjaGVkdWxlcnMuaW5zaWRlQW5ndWxhciksXG4gICAgICBzd2l0Y2hNYXAobWVzc2FnaW5nID0+IGZpcmViYXNlLm1lc3NhZ2luZy5pc1N1cHBvcnRlZCgpID8gbmV3IE9ic2VydmFibGU8c3RyaW5nPihlbWl0dGVyID0+XG4gICAgICAgIG1lc3NhZ2luZy5vbk1lc3NhZ2UobmV4dCA9PiBlbWl0dGVyLm5leHQobmV4dCksIGVyciA9PiBlbWl0dGVyLmVycm9yKGVyciksICgpID0+IGVtaXR0ZXIuY29tcGxldGUoKSlcbiAgICAgICkgOiBFTVBUWSksXG4gICAgKTtcblxuICAgIHRoaXMucmVxdWVzdFRva2VuID0gb2YodW5kZWZpbmVkKS5waXBlKFxuICAgICAgc3Vic2NyaWJlT24oc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhciksXG4gICAgICBvYnNlcnZlT24oc2NoZWR1bGVycy5pbnNpZGVBbmd1bGFyKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnJlcXVlc3RQZXJtaXNzaW9uKSxcbiAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2YobnVsbCkpLFxuICAgICAgbWVyZ2VNYXAoKCkgPT4gdGhpcy50b2tlbkNoYW5nZXMpXG4gICAgKTtcblxuICAgIC8vIFNFTVZFUig3KTogZHJvcCB0b2tlblxuICAgIHRoaXMuZGVsZXRlVG9rZW4gPSAodG9rZW4/OiBzdHJpbmcpID0+IG1lc3NhZ2luZy5waXBlKFxuICAgICAgc3Vic2NyaWJlT24oc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhciksXG4gICAgICBvYnNlcnZlT24oc2NoZWR1bGVycy5pbnNpZGVBbmd1bGFyKSxcbiAgICAgIHN3aXRjaE1hcChtZXNzYWdpbmcgPT4gbWVzc2FnaW5nLmRlbGV0ZVRva2VuKHRva2VuIHx8IHVuZGVmaW5lZCkpLFxuICAgICAgZGVmYXVsdElmRW1wdHkoZmFsc2UpXG4gICAgKTtcblxuICAgIHJldHVybiDJtWxhenlTREtQcm94eSh0aGlzLCBtZXNzYWdpbmcsIHpvbmUpO1xuICB9XG5cbn1cblxuybVhcHBseU1peGlucyhBbmd1bGFyRmlyZU1lc3NhZ2luZywgW3Byb3h5UG9seWZpbGxDb21wYXRdKTtcbiJdfQ==