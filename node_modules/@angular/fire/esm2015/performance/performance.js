/**
 * @fileoverview added by tsickle
 * Generated from: performance.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, Injectable, InjectionToken, NgZone, Optional, PLATFORM_ID } from '@angular/core';
import { EMPTY, Observable, of } from 'rxjs';
import { map, shareReplay, switchMap, tap } from 'rxjs/operators';
import { FirebaseApp, ɵapplyMixins, ɵlazySDKProxy } from '@angular/fire';
import { isPlatformBrowser } from '@angular/common';
import { proxyPolyfillCompat } from './base';
import { ɵfetchInstance } from '@angular/fire';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire";
// SEMVER @ v6, drop and move core ng metrics to a service
/** @type {?} */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/fire';
export const AUTOMATICALLY_TRACE_CORE_NG_METRICS = new InjectionToken('angularfire2.performance.auto_trace');
/** @type {?} */
export const INSTRUMENTATION_ENABLED = new InjectionToken('angularfire2.performance.instrumentationEnabled');
/** @type {?} */
export const DATA_COLLECTION_ENABLED = new InjectionToken('angularfire2.performance.dataCollectionEnabled');
// WARNING: interface has both a type and a value, skipping emit
export class AngularFirePerformance {
    /**
     * @param {?} app
     * @param {?} instrumentationEnabled
     * @param {?} dataCollectionEnabled
     * @param {?} zone
     * @param {?} platformId
     */
    constructor(app, instrumentationEnabled, dataCollectionEnabled, zone, 
    // tslint:disable-next-line:ban-types
    platformId) {
        this.zone = zone;
        this.performance = of(undefined).pipe(switchMap((/**
         * @return {?}
         */
        () => isPlatformBrowser(platformId) ? zone.runOutsideAngular((/**
         * @return {?}
         */
        () => import('firebase/performance'))) : EMPTY)), map((/**
         * @return {?}
         */
        () => ɵfetchInstance(`performance`, 'AngularFirePerformance', app, (/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const performance = zone.runOutsideAngular((/**
             * @return {?}
             */
            () => app.performance()));
            if (instrumentationEnabled === false) {
                performance.instrumentationEnabled = false;
            }
            if (dataCollectionEnabled === false) {
                performance.dataCollectionEnabled = false;
            }
            return performance;
        }), [instrumentationEnabled, dataCollectionEnabled]))), shareReplay({ bufferSize: 1, refCount: false }));
        return ɵlazySDKProxy(this, this.performance, zone);
    }
}
AngularFirePerformance.ɵfac = function AngularFirePerformance_Factory(t) { return new (t || AngularFirePerformance)(ɵngcc0.ɵɵinject(ɵngcc1.FirebaseApp), ɵngcc0.ɵɵinject(INSTRUMENTATION_ENABLED, 8), ɵngcc0.ɵɵinject(DATA_COLLECTION_ENABLED, 8), ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(PLATFORM_ID)); };
/** @nocollapse */
AngularFirePerformance.ctorParameters = () => [
    { type: FirebaseApp },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [INSTRUMENTATION_ENABLED,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [DATA_COLLECTION_ENABLED,] }] },
    { type: NgZone },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
/** @nocollapse */ AngularFirePerformance.ɵprov = i0.ɵɵdefineInjectable({ factory: function AngularFirePerformance_Factory() { return new AngularFirePerformance(i0.ɵɵinject(i1.FirebaseApp), i0.ɵɵinject(INSTRUMENTATION_ENABLED, 8), i0.ɵɵinject(DATA_COLLECTION_ENABLED, 8), i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i0.PLATFORM_ID)); }, token: AngularFirePerformance, providedIn: "any" });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFirePerformance, [{
        type: Injectable,
        args: [{
                providedIn: 'any'
            }]
    }], function () { return [{ type: ɵngcc1.FirebaseApp }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [INSTRUMENTATION_ENABLED]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [DATA_COLLECTION_ENABLED]
            }] }, { type: ɵngcc0.NgZone }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }]; }, null); })();
if (false) {
    /**
     * @type {?}
     * @private
     */
    AngularFirePerformance.prototype.performance;
    /**
     * @type {?}
     * @private
     */
    AngularFirePerformance.prototype.zone;
}
/** @type {?} */
const trace$ = (/**
 * @param {?} traceId
 * @return {?}
 */
(traceId) => {
    if (typeof window !== 'undefined' && window.performance) {
        /** @type {?} */
        const entries = window.performance.getEntriesByName(traceId, 'measure') || [];
        /** @type {?} */
        const startMarkName = `_${traceId}Start[${entries.length}]`;
        /** @type {?} */
        const endMarkName = `_${traceId}End[${entries.length}]`;
        return new Observable((/**
         * @param {?} emitter
         * @return {?}
         */
        emitter => {
            window.performance.mark(startMarkName);
            emitter.next();
            return {
                unsubscribe: (/**
                 * @return {?}
                 */
                () => {
                    window.performance.mark(endMarkName);
                    window.performance.measure(traceId, startMarkName, endMarkName);
                })
            };
        }));
    }
    else {
        return EMPTY;
    }
});
const ɵ0 = trace$;
/** @type {?} */
export const traceUntil = (/**
 * @template T
 * @param {?} name
 * @param {?} test
 * @param {?=} options
 * @return {?}
 */
(name, test, options) => (/**
 * @param {?} source$
 * @return {?}
 */
(source$) => new Observable((/**
 * @param {?} subscriber
 * @return {?}
 */
subscriber => {
    /** @type {?} */
    const traceSubscription = trace$(name).subscribe();
    return source$.pipe(tap((/**
     * @param {?} a
     * @return {?}
     */
    a => test(a) && traceSubscription.unsubscribe()), (/**
     * @return {?}
     */
    () => {
    }), (/**
     * @return {?}
     */
    () => options && options.orComplete && traceSubscription.unsubscribe()))).subscribe(subscriber);
}))));
/** @type {?} */
export const traceWhile = (/**
 * @template T
 * @param {?} name
 * @param {?} test
 * @param {?=} options
 * @return {?}
 */
(name, test, options) => (/**
 * @param {?} source$
 * @return {?}
 */
(source$) => new Observable((/**
 * @param {?} subscriber
 * @return {?}
 */
subscriber => {
    /** @type {?} */
    let traceSubscription;
    return source$.pipe(tap((/**
     * @param {?} a
     * @return {?}
     */
    a => {
        if (test(a)) {
            traceSubscription = traceSubscription || trace$(name).subscribe();
        }
        else {
            if (traceSubscription) {
                traceSubscription.unsubscribe();
            }
            traceSubscription = undefined;
        }
    }), (/**
     * @return {?}
     */
    () => {
    }), (/**
     * @return {?}
     */
    () => options && options.orComplete && traceSubscription && traceSubscription.unsubscribe()))).subscribe(subscriber);
}))));
/** @type {?} */
export const traceUntilComplete = (/**
 * @template T
 * @param {?} name
 * @return {?}
 */
(name) => (/**
 * @param {?} source$
 * @return {?}
 */
(source$) => new Observable((/**
 * @param {?} subscriber
 * @return {?}
 */
subscriber => {
    /** @type {?} */
    const traceSubscription = trace$(name).subscribe();
    return source$.pipe(tap((/**
     * @return {?}
     */
    () => {
    }), (/**
     * @return {?}
     */
    () => {
    }), (/**
     * @return {?}
     */
    () => traceSubscription.unsubscribe()))).subscribe(subscriber);
}))));
/** @type {?} */
export const traceUntilFirst = (/**
 * @template T
 * @param {?} name
 * @return {?}
 */
(name) => (/**
 * @param {?} source$
 * @return {?}
 */
(source$) => new Observable((/**
 * @param {?} subscriber
 * @return {?}
 */
subscriber => {
    /** @type {?} */
    const traceSubscription = trace$(name).subscribe();
    return source$.pipe(tap((/**
     * @return {?}
     */
    () => traceSubscription.unsubscribe()), (/**
     * @return {?}
     */
    () => {
    }), (/**
     * @return {?}
     */
    () => {
    }))).subscribe(subscriber);
}))));
/** @type {?} */
export const trace = (/**
 * @template T
 * @param {?} name
 * @return {?}
 */
(name) => (/**
 * @param {?} source$
 * @return {?}
 */
(source$) => new Observable((/**
 * @param {?} subscriber
 * @return {?}
 */
subscriber => {
    /** @type {?} */
    const traceSubscription = trace$(name).subscribe();
    return source$.pipe(tap((/**
     * @return {?}
     */
    () => traceSubscription.unsubscribe()), (/**
     * @return {?}
     */
    () => {
    }), (/**
     * @return {?}
     */
    () => traceSubscription.unsubscribe()))).subscribe(subscriber);
}))));
ɵapplyMixins(AngularFirePerformance, [proxyPolyfillCompat]);
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyZm9ybWFuY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3dvcmtzcGFjZS9zcmMvcGVyZm9ybWFuY2UvcGVyZm9ybWFuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEcsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUMzRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUN4RixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDN0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvQztBQUNvQztBQUN0QjtBQUEyRDs7O0FBQXpFLE1BQU0sT0FBTyxtQ0FBbUMsR0FBRyxJQUFJLGNBQWMsQ0FBVSxxQ0FBcUMsQ0FBQztBQUNySDtBQUFBLE1BQU0sT0FBTyx1QkFBdUIsR0FBRyxJQUFJLGNBQWMsQ0FBVSxpREFBaUQsQ0FBQztBQUNySDtBQUFBLE1BQU0sT0FBTyx1QkFBdUIsR0FBRyxJQUFJLGNBQWMsQ0FBVSxnREFBZ0QsQ0FBQztBQUNwSDtBQU9BLE1BQU0sT0FBTyxzQkFBc0I7QUFDbkM7QUFDTztBQUFzQjtBQUF5QztBQUd0RDtBQUNDO0FBQTZCO0FBQVEsSUFGcEQsWUFDRSxHQUFnQixFQUM2QixzQkFBc0MsRUFDdEMscUJBQXFDLEVBQzFFLElBQVk7QUFDdkIsSUFBRyxxQ0FBcUM7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QUFDLEVBQUMsQ0FBQSxDQUFBO0FBQ0Y7QUFDQSxNQUFNLE9BQU8sS0FBSztBQUFRO0FBQWU7QUFBbUI7QUFBZTtBQUF0RCxDQUFVLElBQVksRUFBRSxFQUFFO0FBQU07QUFBc0I7QUFBZTtBQUExQyxDQUFDLE9BQXNCLEVBQUUsRUFBRSxDQUFDLElBQUksVUFBVTtBQUFNO0FBQ3JGO0FBQWU7QUFEb0UsVUFBVSxDQUFDLEVBQUU7QUFDM0c7QUFBcUIsVUFBYixpQkFBaUIsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxFQUFFO0FBQ3BELElBQUUsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUNqQixHQUFHO0FBQ0g7QUFBbUI7QUFBUSxJQUF6QixHQUFHLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLEVBQUU7QUFDckM7QUFFSjtBQUFRLElBRkosR0FBRyxFQUFFO0FBQ1gsSUFBTSxDQUFDO0FBQ0Q7QUFBbUI7QUFBUSxJQUEzQixHQUFHLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLEVBQUUsRUFDdEMsQ0FDRixDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMxQixDQUFDLEVBQUMsQ0FBQSxDQUFBO0FBRUYsWUFBWSxDQUFDLHNCQUFzQixFQUFFLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO0FBQzVEO0FBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBOZ1pvbmUsIE9wdGlvbmFsLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIG9mLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IGZpcmViYXNlIGZyb20gJ2ZpcmViYXNlL2FwcCc7XG5pbXBvcnQgeyBGaXJlYmFzZUFwcCwgybVhcHBseU1peGlucywgybVsYXp5U0RLUHJveHksIMm1UHJvbWlzZVByb3h5IH0gZnJvbSAnQGFuZ3VsYXIvZmlyZSc7XG5pbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBwcm94eVBvbHlmaWxsQ29tcGF0IH0gZnJvbSAnLi9iYXNlJztcbmltcG9ydCB7IMm1ZmV0Y2hJbnN0YW5jZSB9IGZyb20gJ0Bhbmd1bGFyL2ZpcmUnO1xuXG4vLyBTRU1WRVIgQCB2NiwgZHJvcCBhbmQgbW92ZSBjb3JlIG5nIG1ldHJpY3MgdG8gYSBzZXJ2aWNlXG5leHBvcnQgY29uc3QgQVVUT01BVElDQUxMWV9UUkFDRV9DT1JFX05HX01FVFJJQ1MgPSBuZXcgSW5qZWN0aW9uVG9rZW48Ym9vbGVhbj4oJ2FuZ3VsYXJmaXJlMi5wZXJmb3JtYW5jZS5hdXRvX3RyYWNlJyk7XG5leHBvcnQgY29uc3QgSU5TVFJVTUVOVEFUSU9OX0VOQUJMRUQgPSBuZXcgSW5qZWN0aW9uVG9rZW48Ym9vbGVhbj4oJ2FuZ3VsYXJmaXJlMi5wZXJmb3JtYW5jZS5pbnN0cnVtZW50YXRpb25FbmFibGVkJyk7XG5leHBvcnQgY29uc3QgREFUQV9DT0xMRUNUSU9OX0VOQUJMRUQgPSBuZXcgSW5qZWN0aW9uVG9rZW48Ym9vbGVhbj4oJ2FuZ3VsYXJmaXJlMi5wZXJmb3JtYW5jZS5kYXRhQ29sbGVjdGlvbkVuYWJsZWQnKTtcblxuZXhwb3J0IGludGVyZmFjZSBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlIGV4dGVuZHMgybVQcm9taXNlUHJveHk8ZmlyZWJhc2UucGVyZm9ybWFuY2UuUGVyZm9ybWFuY2U+IHtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAnYW55J1xufSlcbmV4cG9ydCBjbGFzcyBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlIHtcblxuICBwcml2YXRlIHJlYWRvbmx5IHBlcmZvcm1hbmNlOiBPYnNlcnZhYmxlPGZpcmViYXNlLnBlcmZvcm1hbmNlLlBlcmZvcm1hbmNlPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBhcHA6IEZpcmViYXNlQXBwLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSU5TVFJVTUVOVEFUSU9OX0VOQUJMRUQpIGluc3RydW1lbnRhdGlvbkVuYWJsZWQ6IGJvb2xlYW4gfCBudWxsLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoREFUQV9DT0xMRUNUSU9OX0VOQUJMRUQpIGRhdGFDb2xsZWN0aW9uRW5hYmxlZDogYm9vbGVhbiB8IG51bGwsXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmJhbi10eXBlc1xuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHBsYXRmb3JtSWQ6IE9iamVjdFxuICApIHtcblxuICAgIHRoaXMucGVyZm9ybWFuY2UgPSBvZih1bmRlZmluZWQpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gaXNQbGF0Zm9ybUJyb3dzZXIocGxhdGZvcm1JZCkgPyB6b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IGltcG9ydCgnZmlyZWJhc2UvcGVyZm9ybWFuY2UnKSkgOiBFTVBUWSksXG4gICAgICBtYXAoKCkgPT4gybVmZXRjaEluc3RhbmNlKGBwZXJmb3JtYW5jZWAsICdBbmd1bGFyRmlyZVBlcmZvcm1hbmNlJywgYXBwLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHBlcmZvcm1hbmNlID0gem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiBhcHAucGVyZm9ybWFuY2UoKSk7XG4gICAgICAgIGlmIChpbnN0cnVtZW50YXRpb25FbmFibGVkID09PSBmYWxzZSkge1xuICAgICAgICAgIHBlcmZvcm1hbmNlLmluc3RydW1lbnRhdGlvbkVuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF0YUNvbGxlY3Rpb25FbmFibGVkID09PSBmYWxzZSkge1xuICAgICAgICAgIHBlcmZvcm1hbmNlLmRhdGFDb2xsZWN0aW9uRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwZXJmb3JtYW5jZTtcbiAgICAgIH0sIFtpbnN0cnVtZW50YXRpb25FbmFibGVkLCBkYXRhQ29sbGVjdGlvbkVuYWJsZWRdKSksXG4gICAgICBzaGFyZVJlcGxheSh7IGJ1ZmZlclNpemU6IDEsIHJlZkNvdW50OiBmYWxzZSB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gybVsYXp5U0RLUHJveHkodGhpcywgdGhpcy5wZXJmb3JtYW5jZSwgem9uZSk7XG5cbiAgfVxuXG59XG5cbmNvbnN0IHRyYWNlJCA9ICh0cmFjZUlkOiBzdHJpbmcpID0+IHtcbiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5wZXJmb3JtYW5jZSkge1xuICAgIGNvbnN0IGVudHJpZXMgPSB3aW5kb3cucGVyZm9ybWFuY2UuZ2V0RW50cmllc0J5TmFtZSh0cmFjZUlkLCAnbWVhc3VyZScpIHx8IFtdO1xuICAgIGNvbnN0IHN0YXJ0TWFya05hbWUgPSBgXyR7dHJhY2VJZH1TdGFydFske2VudHJpZXMubGVuZ3RofV1gO1xuICAgIGNvbnN0IGVuZE1hcmtOYW1lID0gYF8ke3RyYWNlSWR9RW5kWyR7ZW50cmllcy5sZW5ndGh9XWA7XG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPHZvaWQ+KGVtaXR0ZXIgPT4ge1xuICAgICAgd2luZG93LnBlcmZvcm1hbmNlLm1hcmsoc3RhcnRNYXJrTmFtZSk7XG4gICAgICBlbWl0dGVyLm5leHQoKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHVuc3Vic2NyaWJlOiAoKSA9PiB7XG4gICAgICAgICAgd2luZG93LnBlcmZvcm1hbmNlLm1hcmsoZW5kTWFya05hbWUpO1xuICAgICAgICAgIHdpbmRvdy5wZXJmb3JtYW5jZS5tZWFzdXJlKHRyYWNlSWQsIHN0YXJ0TWFya05hbWUsIGVuZE1hcmtOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gRU1QVFk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCB0cmFjZVVudGlsID0gPFQgPSBhbnk+KFxuICBuYW1lOiBzdHJpbmcsXG4gIHRlc3Q6IChhOiBUKSA9PiBib29sZWFuLFxuICBvcHRpb25zPzogeyBvckNvbXBsZXRlPzogYm9vbGVhbiB9XG4pID0+IChzb3VyY2UkOiBPYnNlcnZhYmxlPFQ+KSA9PiBuZXcgT2JzZXJ2YWJsZTxUPihzdWJzY3JpYmVyID0+IHtcbiAgY29uc3QgdHJhY2VTdWJzY3JpcHRpb24gPSB0cmFjZSQobmFtZSkuc3Vic2NyaWJlKCk7XG4gIHJldHVybiBzb3VyY2UkLnBpcGUoXG4gICAgdGFwKFxuICAgICAgYSA9PiB0ZXN0KGEpICYmIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCksXG4gICAgICAoKSA9PiB7XG4gICAgICB9LFxuICAgICAgKCkgPT4gb3B0aW9ucyAmJiBvcHRpb25zLm9yQ29tcGxldGUgJiYgdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxuICAgIClcbiAgKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG59KTtcblxuZXhwb3J0IGNvbnN0IHRyYWNlV2hpbGUgPSA8VCA9IGFueT4oXG4gIG5hbWU6IHN0cmluZyxcbiAgdGVzdDogKGE6IFQpID0+IGJvb2xlYW4sXG4gIG9wdGlvbnM/OiB7IG9yQ29tcGxldGU/OiBib29sZWFuIH1cbikgPT4gKHNvdXJjZSQ6IE9ic2VydmFibGU8VD4pID0+IG5ldyBPYnNlcnZhYmxlPFQ+KHN1YnNjcmliZXIgPT4ge1xuICBsZXQgdHJhY2VTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiB8IHVuZGVmaW5lZDtcbiAgcmV0dXJuIHNvdXJjZSQucGlwZShcbiAgICB0YXAoXG4gICAgICBhID0+IHtcbiAgICAgICAgaWYgKHRlc3QoYSkpIHtcbiAgICAgICAgICB0cmFjZVN1YnNjcmlwdGlvbiA9IHRyYWNlU3Vic2NyaXB0aW9uIHx8IHRyYWNlJChuYW1lKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodHJhY2VTdWJzY3JpcHRpb24pIHtcbiAgICAgICAgICAgIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdHJhY2VTdWJzY3JpcHRpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICAoKSA9PiB7XG4gICAgICB9LFxuICAgICAgKCkgPT4gb3B0aW9ucyAmJiBvcHRpb25zLm9yQ29tcGxldGUgJiYgdHJhY2VTdWJzY3JpcHRpb24gJiYgdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxuICAgIClcbiAgKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG59KTtcblxuZXhwb3J0IGNvbnN0IHRyYWNlVW50aWxDb21wbGV0ZSA9IDxUID0gYW55PihuYW1lOiBzdHJpbmcpID0+IChzb3VyY2UkOiBPYnNlcnZhYmxlPFQ+KSA9PiBuZXcgT2JzZXJ2YWJsZTxUPihzdWJzY3JpYmVyID0+IHtcbiAgY29uc3QgdHJhY2VTdWJzY3JpcHRpb24gPSB0cmFjZSQobmFtZSkuc3Vic2NyaWJlKCk7XG4gIHJldHVybiBzb3VyY2UkLnBpcGUoXG4gICAgdGFwKFxuICAgICAgKCkgPT4ge1xuICAgICAgfSxcbiAgICAgICgpID0+IHtcbiAgICAgIH0sXG4gICAgICAoKSA9PiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpXG4gICAgKVxuICApLnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbn0pO1xuXG5leHBvcnQgY29uc3QgdHJhY2VVbnRpbEZpcnN0ID0gPFQgPSBhbnk+KG5hbWU6IHN0cmluZykgPT4gKHNvdXJjZSQ6IE9ic2VydmFibGU8VD4pID0+IG5ldyBPYnNlcnZhYmxlPFQ+KHN1YnNjcmliZXIgPT4ge1xuICBjb25zdCB0cmFjZVN1YnNjcmlwdGlvbiA9IHRyYWNlJChuYW1lKS5zdWJzY3JpYmUoKTtcbiAgcmV0dXJuIHNvdXJjZSQucGlwZShcbiAgICB0YXAoXG4gICAgICAoKSA9PiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpLFxuICAgICAgKCkgPT4ge1xuICAgICAgfSxcbiAgICAgICgpID0+IHtcbiAgICAgIH1cbiAgICApXG4gICkuc3Vic2NyaWJlKHN1YnNjcmliZXIpO1xufSk7XG5cbmV4cG9ydCBjb25zdCB0cmFjZSA9IDxUID0gYW55PihuYW1lOiBzdHJpbmcpID0+IChzb3VyY2UkOiBPYnNlcnZhYmxlPFQ+KSA9PiBuZXcgT2JzZXJ2YWJsZTxUPihzdWJzY3JpYmVyID0+IHtcbiAgY29uc3QgdHJhY2VTdWJzY3JpcHRpb24gPSB0cmFjZSQobmFtZSkuc3Vic2NyaWJlKCk7XG4gIHJldHVybiBzb3VyY2UkLnBpcGUoXG4gICAgdGFwKFxuICAgICAgKCkgPT4gdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKSxcbiAgICAgICgpID0+IHtcbiAgICAgIH0sXG4gICAgICAoKSA9PiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpXG4gICAgKVxuICApLnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbn0pO1xuXG7JtWFwcGx5TWl4aW5zKEFuZ3VsYXJGaXJlUGVyZm9ybWFuY2UsIFtwcm94eVBvbHlmaWxsQ29tcGF0XSk7XG4iXX0=